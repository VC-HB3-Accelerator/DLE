# Финальная безопасная конфигурация nginx

server {
    listen 80;
    server_name hb3-accelerator.com www.hb3-accelerator.com localhost 127.0.0.1;

    root /usr/share/nginx/html;
    index index.html;

    # Блокировка агрессивных сканеров
    if ($http_user_agent ~* (sqlmap|nikto|dirb|gobuster|wfuzz|burp|zap|nessus|openvas)) {
        return 403;
    }

    # Блокировка очень старых браузеров
    if ($http_user_agent ~* "MSIE [1-8]\.") {
        return 403;
    }

    # Блокировка опасных файлов (НЕ блокируем .js, .css)
    if ($request_uri ~* "\.(php|asp|aspx|jsp|cgi|pl|py|sh|bash|exe|bat|cmd|com|pif|scr|vbs|vbe|jar|war|ear|dll|so|dylib|bin|sys|ini|log|bak|old|tmp|temp|swp|swo|~)$") {
        return 404;
    }

    # Блокировка WordPress сканирования
    if ($request_uri ~* "(wp-admin|wp-content|wp-includes|wp-config|wp-login|xmlrpc)") {
        return 404;
    }

    # Блокировка path traversal
    if ($request_uri ~* "(\.\.|\.\./|\.\.\\|\.\.%2f|\.\.%5c)") {
        return 404;
    }

    # Блокировка конкретных атакующих IP
    if ($remote_addr = "198.55.98.76") {
        return 403;
    }

    # Основной location
    location / {
        try_files $uri $uri/ /index.html =404;
        
        # Заголовки безопасности
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' ws: wss:;" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    }

    # API с дополнительной защитой
    location /api/ {
        proxy_pass http://dapp-backend:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Таймауты
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # Заголовки безопасности для API
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }

    # WebSocket с защитой
    location /ws {
        proxy_pass http://dapp-backend:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Таймауты для WebSocket
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 300s;
    }

    # Статические файлы с кешированием и защитой
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary Accept-Encoding;
        
        # Дополнительная защита для статических файлов
        add_header X-Content-Type-Options "nosniff" always;
    }

    # Запрет доступа к чувствительным файлам
    location ~* /(\.htaccess|\.htpasswd|\.env|\.git|\.svn|\.DS_Store|Thumbs\.db|web\.config|robots\.txt|sitemap\.xml)$ {
        deny all;
        return 404;
    }

    # Строгая защита от доступа к конфигурационным файлам
    location ~* /\.(env|config|ini|conf|cfg|yml|yaml|json|xml|sql|db|bak|backup|old|tmp|temp|log)$ {
        deny all;
        return 404;
    }

    # Скрытие информации о сервере
    server_tokens off;
    
    # Логирование ошибок
    error_log /var/log/nginx/error.log warn;
    access_log /var/log/nginx/access.log combined;
} 