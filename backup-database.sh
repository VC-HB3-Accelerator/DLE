#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö DLE
# –ó–∞–ø—É—Å–∫–∞—Ç—å: ./backup-database.sh

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
BACKUP_DIR="./backups"
DB_NAME="${DB_NAME:-dapp_db}"
DB_USER="${DB_USER:-dapp_user}"
DB_PASSWORD="${DB_PASSWORD:-dapp_password}"
CONTAINER_NAME="dapp-postgres"

# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è –±—ç–∫–∞–ø–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p "$BACKUP_DIR"

# –ò–º—è —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
BACKUP_FILE="$BACKUP_DIR/backup_$(date +%Y%m%d_%H%M%S).sql"

echo "üîí –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
echo "üìÅ –§–∞–π–ª: $BACKUP_FILE"

# –°–æ–∑–¥–∞—ë–º –±—ç–∫–∞–ø
docker exec "$CONTAINER_NAME" pg_dump -U "$DB_USER" "$DB_NAME" > "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ë—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
    echo "üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(du -h "$BACKUP_FILE" | cut -f1)"
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
    echo "üßπ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤..."
    ls -t "$BACKUP_DIR"/backup_*.sql | tail -n +11 | xargs -r rm
    
    echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –±—ç–∫–∞–ø—ã:"
    ls -lh "$BACKUP_DIR"/backup_*.sql | tail -5
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–∞–ø–∞!"
    exit 1
fi 