# –ó–∞–¥–∞—á–∞: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ—Å—Ç–µ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-10-09  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í–´–°–û–ö–ò–ô  
**–°—Ç–∞—Ç—É—Å:** üîÑ –í –†–ê–ó–†–ê–ë–û–¢–ö–ï (95% –≥–æ—Ç–æ–≤–æ)

### ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û:
- ‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- ‚úÖ –í—Å–µ –±–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –º–µ–¥–∏–∞
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞
- ‚úÖ –†–æ—É—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã

### üìã –û–°–¢–ê–õ–û–°–¨:
- üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –º–µ–¥–∏–∞-–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 10-14 —á–∞—Å–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û

### –ü–ï–†–ï–ü–ò–°–´–í–ê–ï–¢–°–Ø –°–¢–ê–†–ê–Ø –õ–û–ì–ò–ö–ê:
- `unifiedMessageProcessor.js` - –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞
- `guestService.js` - deprecated
- `guestMessageService.js` - deprecated  
- `telegramBot.js` - –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- `emailBot.js` - –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- `webBot.js` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ–¥–∏–∞

### –î–û–ë–ê–í–õ–ï–ù–ê –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ú–ï–î–ò–ê-–°–ò–°–¢–ï–ú–ê:
- `UniversalMediaProcessor.js` - –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞: –∞—É–¥–∏–æ, –≤–∏–¥–µ–æ, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∞—Ä—Ö–∏–≤—ã
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤ (Web, Telegram, Email)
- –†–µ–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞

### –£–î–ê–õ–Ø–Æ–¢–°–Ø –í–°–ï –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï:
- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (users)
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è (messages)
- –í—Å–µ –±–µ—Å–µ–¥—ã (conversations)
- –í—Å–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (user_identities)

### –ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:
- **–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ë–ï–ó –∫–æ—à–µ–ª—å–∫–∞ = –≥–æ—Å—Ç–∏**
- **–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π user_id —Ç–æ–ª—å–∫–æ —É –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –∫–æ—à–µ–ª—å–∫–æ–≤**
- **–ò—Å—Ç–æ—Ä–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∏–≥—Ä–∏—Ä—É–µ—Ç –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–∞**

---

## üéØ –¶–ï–õ–¨

–°–æ–∑–¥–∞—Ç—å **—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É** –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≥–æ—Å—Ç–µ–π) –¥–ª—è **–≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏** (Web, Telegram, Email) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ Web3 –∫–æ—à–µ–ª—å–∫–∞ –∏ **—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–∞**.

---

## üî• –ü–†–û–ë–õ–ï–ú–´ –¢–ï–ö–£–©–ï–ô –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### ‚ùå –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å:

1. **–†–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤:**
   - Web: –≥–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `guest_messages` –ë–ï–ó `user_id`
   - Telegram: –°–†–ê–ó–£ —Å–æ–∑–¥–∞–µ—Ç—Å—è `user_id` –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
   - Email: –°–†–ê–ó–£ —Å–æ–∑–¥–∞–µ—Ç—Å—è `user_id` –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–∏—Å—å–º–µ

2. **–°–æ–∑–¥–∞—é—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
   ```
   –°—Ü–µ–Ω–∞—Ä–∏–π: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –≤ Telegram ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è user_id=42
             –ü–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç –∫–æ—à–µ–ª–µ–∫ –Ω–∞ —Å–∞–π—Ç–µ ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è user_id=99
   –†–µ–∑—É–ª—å—Ç–∞—Ç: –î–í–ê –∞–∫–∫–∞—É–Ω—Ç–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –∏—Å—Ç–æ—Ä–∏—è–º–∏!
   ```

3. **AI –æ—Ç–≤–µ—Ç—ã –≥–æ—Å—Ç—è–º –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:**
   - Web –≥–æ—Å—Ç–∏: –æ—Ç–≤–µ—Ç—ã AI –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ë–î
   - Telegram/Email: —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –Ω–æ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
   
4. **–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Ä—è–µ—Ç—Å—è:**
   - Web –≥–æ—Å—Ç–∏ –Ω–µ –∏–º–µ—é—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ AI
   - –ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏—è –º–æ–∂–µ—Ç –Ω–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å

5. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è:**
   - –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ —Å–≤—è–∑–∞—Ç—å Telegram/Email —Å –∫–æ—à–µ–ª—å–∫–æ–º –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
   - –ù–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤

6. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –µ–¥–∏–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–∞:**
   - –†–∞–∑–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Ñ–∞–π–ª—ã –ø–æ-—Ä–∞–∑–Ω–æ–º—É
   - –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –∏ —Ä–∞–∑–º–µ—Ä–æ–≤
   - –ú–µ–¥–∏–∞-—Ñ–∞–π–ª—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ä–∞–∑–ª–∏—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É –∫–∞–Ω–∞–ª–∞–º–∏

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï: –í–∞—Ä–∏–∞–Ω—Ç C + —ç–ª–µ–º–µ–Ω—Ç—ã –í–∞—Ä–∏–∞–Ω—Ç–∞ A

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     –í–°–ï –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ë–ï–ó –∫–æ—à–µ–ª—å–∫–∞ = "–ì–û–°–¢–ò"             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Web:      web:guest_abc123                              ‚îÇ
‚îÇ Telegram: telegram:123456789                            ‚îÇ
‚îÇ Email:    email:user@example.com                        ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ ‚Üí –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ unified_guest_messages                  ‚îÇ
‚îÇ ‚Üí –ò—Å—Ç–æ—Ä–∏—è + AI –æ—Ç–≤–µ—Ç—ã —Å is_ai=true/false                ‚îÇ
‚îÇ ‚Üí –ú–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ UniversalMediaProcessor           ‚îÇ
‚îÇ ‚Üí –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è user_id –¥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
              [–°–≤—è–∑—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω]
              –ë–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É ‚Üí
              –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç ‚Üí
              –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –∫–æ—à–µ–ª–µ–∫
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         –ü–û–õ–ù–û–¶–ï–ù–ù–´–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ (—Å –∫–æ—à–µ–ª—å–∫–æ–º)          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ users: user_id = 42, role = 'user'/'editor'             ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ user_identities:                                        ‚îÇ
‚îÇ - wallet: 0x1234... (–≥–ª–∞–≤–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)             ‚îÇ
‚îÇ - telegram: 123456789 (—Å–≤—è–∑–∞–Ω–Ω—ã–π)                       ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ messages:                                               ‚îÇ
‚îÇ - –í–°–Ø –∏—Å—Ç–æ—Ä–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞                  ‚îÇ
‚îÇ - conversation_id —Å–æ–∑–¥–∞–Ω–∞                               ‚îÇ
‚îÇ - —Ä–æ–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (user/assistant)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üì¶ –ö–û–ú–ü–û–ù–ï–ù–¢–´ –°–ò–°–¢–ï–ú–´

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (3 –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü—ã)

#### 1.1. `unified_guest_messages` - –ï–¥–∏–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏—Å—Ç–æ—Ä–∏–∏

```sql
CREATE TABLE unified_guest_messages (
  id SERIAL PRIMARY KEY,
  
  -- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
  identifier_encrypted TEXT NOT NULL,
  -- –ü—Ä–∏–º–µ—Ä—ã: 
  --   "web:guest_abc123def456..."
  --   "telegram:123456789"
  --   "email:user@example.com"
  
  -- –ö–∞–Ω–∞–ª
  channel VARCHAR(20) NOT NULL,  -- 'web', 'telegram', 'email'
  
  -- –ö–æ–Ω—Ç–µ–Ω—Ç
  content_encrypted TEXT NOT NULL,
  
  -- –†–æ–ª—å (–∫—Ç–æ –∞–≤—Ç–æ—Ä: –≥–æ—Å—Ç—å –∏–ª–∏ AI)
  is_ai BOOLEAN DEFAULT false NOT NULL,
  
  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞ (JSON)
  metadata JSONB DEFAULT '{}',
  -- –ü—Ä–∏–º–µ—Ä—ã:
  --   Telegram: {"username": "@user", "first_name": "John", "chat_id": 123}
  --   Email: {"from": "user@example.com", "subject": "Question"}
  
  -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- –í–ª–æ–∂–µ–Ω–∏—è
  attachment_filename_encrypted TEXT,
  attachment_mimetype_encrypted TEXT,
  attachment_size BIGINT,
  attachment_data BYTEA,
  
  -- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
  CONSTRAINT check_channel CHECK (channel IN ('web', 'telegram', 'email'))
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_unified_guest_identifier ON unified_guest_messages(identifier_encrypted);
CREATE INDEX idx_unified_guest_channel ON unified_guest_messages(channel);
CREATE INDEX idx_unified_guest_created_at ON unified_guest_messages(created_at DESC);
CREATE INDEX idx_unified_guest_is_ai ON unified_guest_messages(is_ai);
```

#### 1.2. `identity_link_tokens` - –¢–æ–∫–µ–Ω—ã –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è

```sql
CREATE TABLE identity_link_tokens (
  id SERIAL PRIMARY KEY,
  
  -- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
  token VARCHAR(64) UNIQUE NOT NULL,
  
  -- –ö–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–µ–º (–∏—Å—Ç–æ—á–Ω–∏–∫)
  source_provider VARCHAR(20) NOT NULL,  -- 'telegram', 'email'
  source_identifier_encrypted TEXT NOT NULL,
  
  -- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π user_id –µ—Å–ª–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  
  -- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
  is_used BOOLEAN DEFAULT false NOT NULL,
  used_at TIMESTAMP WITH TIME ZONE,
  linked_wallet TEXT,  -- –ö–æ—à–µ–ª–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≤—è–∑–∞–ª–∏
  
  -- TTL (Time To Live)
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  CONSTRAINT check_source_provider CHECK (source_provider IN ('telegram', 'email'))
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_link_tokens_token ON identity_link_tokens(token);
CREATE INDEX idx_link_tokens_expires ON identity_link_tokens(expires_at);
CREATE INDEX idx_link_tokens_used ON identity_link_tokens(is_used);
```

#### 1.3. `unified_guest_mapping` - –ú–∞–ø–ø–∏–Ω–≥ –≥–æ—Å—Ç—å ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

```sql
CREATE TABLE unified_guest_mapping (
  id SERIAL PRIMARY KEY,
  
  -- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- –ì–æ—Å—Ç–µ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
  identifier_encrypted TEXT NOT NULL,  -- "telegram:123456789"
  
  -- –ö–∞–Ω–∞–ª
  channel VARCHAR(20) NOT NULL,
  
  -- –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
  processed BOOLEAN DEFAULT false NOT NULL,
  processed_at TIMESTAMP WITH TIME ZONE,
  
  -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
  UNIQUE(identifier_encrypted, channel),
  
  CONSTRAINT check_channel CHECK (channel IN ('web', 'telegram', 'email'))
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_unified_mapping_user_id ON unified_guest_mapping(user_id);
CREATE INDEX idx_unified_mapping_identifier ON unified_guest_mapping(identifier_encrypted);
CREATE INDEX idx_unified_mapping_processed ON unified_guest_mapping(processed);
```

---

### 1.4. `media_files` - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤

```sql
CREATE TABLE media_files (
  id SERIAL PRIMARY KEY,
  file_name VARCHAR(255) NOT NULL,
  original_name VARCHAR(255) NOT NULL,
  file_path TEXT NOT NULL,
  file_size BIGINT NOT NULL,
  file_type VARCHAR(20) NOT NULL,
  mime_type VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  accessed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  download_count INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  
  -- –°–≤—è–∑—å —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
  message_id INTEGER,
  identifier VARCHAR(255),
  channel VARCHAR(50),
  
  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  metadata JSONB,
  
  -- –°–≤—è–∑–∏
  CONSTRAINT fk_media_files_message 
    FOREIGN KEY (message_id) REFERENCES unified_guest_messages(id) ON DELETE CASCADE
);
```

---

### 2. Backend —Å–µ—Ä–≤–∏—Å—ã (3 –Ω–æ–≤—ã—Ö, 3 –æ–±–Ω–æ–≤–∏—Ç—å)

#### 2.1. ‚ú® –ù–û–í–´–ô: `UniversalGuestService.js`

**–ü—É—Ç—å:** `backend/services/UniversalGuestService.js`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**

```javascript
class UniversalGuestService {
  /**
   * –°–æ–∑–¥–∞—Ç—å —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
   * @param {string} channel - 'web', 'telegram', 'email'
   * @param {string} rawId - –ò—Å—Ö–æ–¥–Ω—ã–π ID
   * @returns {string} - "channel:rawId"
   */
  createIdentifier(channel, rawId) {}
  
  /**
   * –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å—Ç–µ–≤–æ–π ID –¥–ª—è Web
   * @returns {string} - "guest_abc123..."
   */
  generateWebGuestId() {}
  
  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≥–æ—Å—Ç—è
   * @param {Object} messageData
   * @returns {Promise<Object>}
   */
  async saveMessage(messageData) {}
  
  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å AI –æ—Ç–≤–µ—Ç –≥–æ—Å—Ç—é
   * @param {Object} responseData
   * @returns {Promise<Object>}
   */
  async saveAiResponse(responseData) {}
  
  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –≥–æ—Å—Ç—è
   * @param {string} identifier - "channel:id"
   * @returns {Promise<Array>} - [{role: 'user'/'assistant', content}]
   */
  async getHistory(identifier) {}
  
  /**
   * –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≥–æ—Å—Ç—è (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å + –ø–æ–ª—É—á–∏—Ç—å AI –æ—Ç–≤–µ—Ç)
   * @param {Object} messageData
   * @returns {Promise<Object>}
   */
  async processMessage(messageData) {}
  
  /**
   * –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≥–æ—Å—Ç—è –≤ user_id
   * @param {string} identifier - "channel:id"
   * @param {number} userId
   * @returns {Promise<Object>}
   */
  async migrateToUser(identifier, userId) {}
  
  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≥–æ—Å—Ç–µ–≤—ã–º
   * @param {string} identifier
   * @returns {boolean}
   */
  isGuest(identifier) {}
  
  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≥–æ—Å—Ç—è–º
   * @returns {Promise<Object>}
   */
  async getStats() {}
}
```

#### 2.2. ‚ú® –ù–û–í–´–ô: `UniversalMediaProcessor.js`

**–ü—É—Ç—å:** `backend/services/UniversalMediaProcessor.js`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞: –∞—É–¥–∏–æ (.mp3, .wav), –≤–∏–¥–µ–æ (.mp4, .avi), –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (.jpg, .jpeg, .png, .gif), –¥–æ–∫—É–º–µ–Ω—Ç—ã (.txt, .pdf, .docx, .xlsx, .pptx, .odt, .ods, .odp), –∞—Ä—Ö–∏–≤—ã (.zip, .rar, .7z)
- –†–µ–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤: 5MB –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, 10MB –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –º–µ–¥–∏–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Ç–µ–∫—Å—Ç + –º–µ–¥–∏–∞)
- Fallback –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
```javascript
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
await processFile(fileData, filename, metadata)

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
await processCombinedContent({
  text: "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
  files: [...],
  audio: {...},
  video: {...}
})

// –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –ë–î
createDatabaseRecord(processedContent, identifier, channel)

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ë–î
restoreFromDatabase(dbRecord)
```

---

#### 2.3. ‚ú® –ù–û–í–´–ô: `IdentityLinkService.js`

**–ü—É—Ç—å:** `backend/services/IdentityLinkService.js`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**

```javascript
class IdentityLinkService {
  /**
   * –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è
   * @param {string} provider - 'telegram', 'email'
   * @param {string} identifier - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {Promise<Object>} - {token, linkUrl, expiresAt}
   */
  async generateLinkToken(provider, identifier) {}
  
  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
   * @param {string} token
   * @returns {Promise<Object|null>}
   */
  async verifyLinkToken(token) {}
  
  /**
   * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω (—Å–≤—è–∑–∞—Ç—å —Å –∫–æ—à–µ–ª—å–∫–æ–º)
   * @param {string} token
   * @param {string} walletAddress
   * @returns {Promise<Object>}
   */
  async useLinkToken(token, walletAddress) {}
  
  /**
   * –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–µ–∫—à–∏–µ —Ç–æ–∫–µ–Ω—ã
   * @returns {Promise<number>} - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö
   */
  async cleanupExpiredTokens() {}
}
```

#### 2.3. üîÑ –ü–ï–†–ï–ü–ò–°–ê–¢–¨: `unifiedMessageProcessor.js`

**‚ö†Ô∏è –°–¢–ê–†–ê–Ø –õ–û–ì–ò–ö–ê –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢–°–Ø**

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```javascript
// –£–î–ê–õ–ò–¢–¨:
async function processGuestMessage(messageData) {
  // –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ —Å guestService
}

// –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê:
async function processMessage(messageData) {
  const { identifier, content, channel } = messageData;
  
  // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º: –≥–æ—Å—Ç—å –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?
  const universalGuestService = require('./UniversalGuestService');
  
  if (universalGuestService.isGuest(identifier)) {
    // –ì–û–°–¢–¨: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ UniversalGuestService
    return await universalGuestService.processMessage(messageData);
  }
  
  // 2. –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨: –∏—â–µ–º user_id
  const identityService = require('./identity-service');
  const [provider, providerId] = identifier.split(':');
  const user = await identityService.findUserByIdentity(provider, providerId);
  
  if (!user) {
    throw new Error('User not found for authenticated message');
  }
  
  const userId = user.id;
  
  // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º: –∞–¥–º–∏–Ω –∏–ª–∏ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?
  const adminLogicService = require('./adminLogicService');
  const isAdmin = user.role === 'editor' || user.role === 'readonly';
  
  // 4. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å AI –æ—Ç–≤–µ—Ç
  const shouldGenerateAi = adminLogicService.shouldGenerateAiReply({
    senderType: isAdmin ? 'admin' : 'user',
    userId: userId,
    recipientId: messageData.recipientId || userId,
    channel: channel
  });
  
  // 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  // ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞)
  
  // 6. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º AI –æ—Ç–≤–µ—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
  if (shouldGenerateAi) {
    // ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞)
  }
  
  return result;
}
```

#### 2.5. üîÑ –û–ë–ù–û–í–ò–¢–¨: `telegramBot.js`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```javascript
// –ë–´–õ–û:
async handleMessage(ctx, processor = null) {
  const telegramId = ctx.from.id.toString();
  
  // ‚ùå –ò—Å–∫–∞–ª/—Å–æ–∑–¥–∞–≤–∞–ª user_id —Å—Ä–∞–∑—É
  const user = await findOrCreateUser(telegramId);
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞...
}

// –°–¢–ê–õ–û:
async handleMessage(ctx, processor = null) {
  const telegramId = ctx.from.id.toString();
  
  // ‚úÖ –°–æ–∑–¥–∞–µ–º –≥–æ—Å—Ç–µ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
  const universalGuestService = require('./UniversalGuestService');
  const identifier = universalGuestService.createIdentifier('telegram', telegramId);
  
  const messageData = {
    identifier: identifier,  // "telegram:123456789"
    content: ctx.message.text,
    channel: 'telegram',
    metadata: {
      telegram_username: ctx.from.username,
      telegram_first_name: ctx.from.first_name,
      telegram_last_name: ctx.from.last_name,
      chat_id: ctx.chat.id
    }
  };
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ unified processor
  const result = await unifiedMessageProcessor.processMessage(messageData);
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
  if (result.success && result.aiResponse) {
    await ctx.reply(result.aiResponse.response);
  }
}

// ‚ú® –ù–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê: /connect
bot.command('connect', async (ctx) => {
  const telegramId = ctx.from.id.toString();
  
  const identityLinkService = require('./IdentityLinkService');
  const linkData = await identityLinkService.generateLinkToken('telegram', telegramId);
  
  await ctx.reply(
    `üîó *–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Web3 –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞*\n\n` +
    `–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ:\n${linkData.linkUrl}\n\n` +
    `‚è± –°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –¥–æ ${linkData.expiresAt}`,
    { parse_mode: 'Markdown' }
  );
});
```

#### 2.6. üîÑ –û–ë–ù–û–í–ò–¢–¨: `emailBot.js`

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–∫ –≤ `telegramBot.js`:**

```javascript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å identifier = "email:user@example.com"
// –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–∏—Å—å–º–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é:
// "–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫: [—Å—Å—ã–ª–∫–∞]"
```

---

#### 2.7. üîÑ –û–ë–ù–û–í–ò–¢–¨: `webBot.js`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `UniversalMediaProcessor`
- –ú–µ—Ç–æ–¥ `processMessage` –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ–¥–∏–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ –º–µ–¥–∏–∞-–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö `contentData`
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –æ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–∞—Ö

```javascript
// –ù–û–í–û–ï: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
if (messageData.attachments && messageData.attachments.length > 0) {
  const processedFiles = [];
  
  for (const attachment of messageData.attachments) {
    const processedFile = await universalMediaProcessor.processFile(
      attachment.data,
      attachment.filename,
      { webUpload: true, originalSize: attachment.size, mimeType: attachment.mimetype }
    );
    processedFiles.push(processedFile);
  }
  
  messageData.contentData = {
    text: messageData.content,
    files: processedFiles.map(file => ({...}))
  };
}
```

---

### 3. Backend —Ä–æ—É—Ç—ã (2 –Ω–æ–≤—ã—Ö, 1 –æ–±–Ω–æ–≤–∏—Ç—å)

#### 3.1. ‚ú® –ù–û–í–´–ô: `POST /api/auth/wallet-with-link`

**–ü—É—Ç—å:** `backend/routes/auth.js`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω —Å–≤—è–∑—ã–≤–∞–Ω–∏—è

```javascript
router.post('/wallet-with-link', async (req, res) => {
  try {
    const { address, signature, token } = req.body;
    
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
    const isValid = await verifySignature(address, signature);
    if (!isValid) {
      return res.status(400).json({ error: '–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å' });
    }
    
    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω
    const identityLinkService = require('../services/IdentityLinkService');
    const linkResult = await identityLinkService.useLinkToken(token, address);
    
    if (!linkResult.success) {
      return res.status(400).json({ error: linkResult.error });
    }
    
    const { userId, identifier } = linkResult;
    
    // 3. –ú–∏–≥—Ä–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –≥–æ—Å—Ç—è
    const universalGuestService = require('../services/UniversalGuestService');
    await universalGuestService.migrateToUser(identifier, userId);
    
    // 4. –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é
    req.session.userId = userId;
    req.session.address = address;
    req.session.authenticated = true;
    await req.session.save();
    
    res.json({ 
      success: true, 
      userId,
      message: '–ö–æ—à–µ–ª–µ–∫ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω, –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞'
    });
    
  } catch (error) {
    logger.error('[Auth] Error in wallet-with-link:', error);
    res.status(500).json({ error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});
```

#### 3.2. ‚ú® –ù–û–í–´–ô: `GET /api/identity/link-status/:token`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ–∫–µ–Ω–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è

```javascript
router.get('/link-status/:token', async (req, res) => {
  try {
    const { token } = req.params;
    
    const identityLinkService = require('../services/IdentityLinkService');
    const tokenData = await identityLinkService.verifyLinkToken(token);
    
    if (!tokenData) {
      return res.json({ 
        valid: false, 
        error: '–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫' 
      });
    }
    
    res.json({
      valid: true,
      provider: tokenData.source_provider,
      expiresAt: tokenData.expires_at,
      isUsed: tokenData.is_used
    });
    
  } catch (error) {
    logger.error('[Identity] Error checking link status:', error);
    res.status(500).json({ error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});
```

#### 3.3. üîÑ –û–ë–ù–û–í–ò–¢–¨: `POST /api/chat/guest-message`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `UniversalMediaProcessor`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ –º–µ–¥–∏–∞-–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö `contentData`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Ç–µ–∫—Å—Ç + –º–µ–¥–∏–∞)

```javascript
// –ë–´–õ–û:
router.post('/guest-message', async (req, res) => {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è Web –≥–æ—Å—Ç–µ–π
  const guestService = require('../services/guestService');
  // ...
});

// –°–¢–ê–õ–û:
router.post('/guest-message', async (req, res) => {
  try {
    const { content, guestId } = req.body;
    
    const universalGuestService = require('../services/UniversalGuestService');
    
    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥–æ—Å—Ç–µ–≤–æ–π ID
    const webGuestId = guestId || universalGuestService.generateWebGuestId();
    const identifier = universalGuestService.createIdentifier('web', webGuestId);
    
    const messageData = {
      identifier: identifier,
      content: content,
      channel: 'web'
    };
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
    const result = await universalGuestService.processMessage(messageData);
    
    res.json({
      success: true,
      guestId: webGuestId,
      aiResponse: result.aiResponse
    });
    
  } catch (error) {
    logger.error('[Chat] Error in guest-message:', error);
    res.status(500).json({ error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});
```

---

### 4. –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–ü—É—Ç—å:** `backend/migrations/`

–°–æ–∑–¥–∞—Ç—å 6 —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π:

#### 4.1. `068_create_unified_guest_messages.sql`

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã unified_guest_messages
-- (—Å–º. —Ä–∞–∑–¥–µ–ª 1.1 –≤—ã—à–µ)
```

#### 4.2. `069_create_identity_link_tokens.sql`

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã identity_link_tokens
-- (—Å–º. —Ä–∞–∑–¥–µ–ª 1.2 –≤—ã—à–µ)
```

#### 4.3. `070_create_unified_guest_mapping.sql`

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã unified_guest_mapping
-- (—Å–º. —Ä–∞–∑–¥–µ–ª 1.3 –≤—ã—à–µ)
```

#### 4.4. `071_cleanup_test_data.sql`

```sql
-- ‚ö†Ô∏è –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –¢–ï–°–¢–û–í–´–• –î–ê–ù–ù–´–•
-- –£–¥–∞–ª—è–µ–º –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

-- 1. –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
TRUNCATE TABLE messages CASCADE;

-- 2. –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –±–µ—Å–µ–¥—ã
TRUNCATE TABLE conversations CASCADE;

-- 3. –£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ—Å–µ–¥
TRUNCATE TABLE conversation_participants CASCADE;

-- 4. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–æ—á—Ç–µ–Ω–∏—è
TRUNCATE TABLE global_read_status CASCADE;
TRUNCATE TABLE admin_read_messages CASCADE;
TRUNCATE TABLE admin_read_contacts CASCADE;

-- 5. –£–¥–∞–ª–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
TRUNCATE TABLE message_deduplication CASCADE;

-- 6. –£–¥–∞–ª–∏—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
TRUNCATE TABLE user_identities CASCADE;

-- 7. –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
TRUNCATE TABLE users RESTART IDENTITY CASCADE;

-- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
RAISE NOTICE '–í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É–¥–∞–ª–µ–Ω—ã. –ë–î –≥–æ—Ç–æ–≤–∞ –∫ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ.';
```

#### 4.5. `072_migrate_existing_guest_data.sql`

#### 4.6. `073_add_media_support_to_unified_guest_messages.sql`

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ `content_type`, `attachments`, `media_metadata` –≤ `unified_guest_messages`
- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `media_files` –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ guest_messages ‚Üí unified_guest_messages

INSERT INTO unified_guest_messages (
  identifier_encrypted,
  channel,
  content_encrypted,
  is_ai,
  created_at,
  attachment_filename_encrypted,
  attachment_mimetype_encrypted,
  attachment_size,
  attachment_data
)
SELECT 
  guest_id_encrypted,  -- –±—É–¥–µ—Ç –∫–∞–∫ "web:guest_..."
  'web',
  content_encrypted,
  COALESCE(is_ai, false),  -- –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ NULL
  created_at,
  attachment_filename_encrypted,
  attachment_mimetype_encrypted,
  attachment_size,
  attachment_data
FROM guest_messages;

-- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
DO $$
DECLARE
  migrated_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO migrated_count FROM unified_guest_messages WHERE channel = 'web';
  RAISE NOTICE '–ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≥–æ—Å—Ç–µ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: %', migrated_count;
END $$;

-- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
DROP TABLE IF EXISTS guest_messages CASCADE;
DROP TABLE IF EXISTS guest_user_mapping CASCADE;
```

---

### 5. Frontend –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### 5.1. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞

**–ü—É—Ç—å:** `frontend/src/views/ConnectWalletView.vue`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**

```vue
<template>
  <div class="connect-wallet-page">
    <!-- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω -->
    <div v-if="tokenValid">
      <h1>üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞</h1>
      <p>–í—ã –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∏–∑ {{ providerName }}</p>
      <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏</p>
      
      <button @click="connectWallet">
        –ü–æ–¥–∫–ª—é—á–∏—Ç—å MetaMask
      </button>
    </div>
    
    <!-- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ -->
    <div v-else>
      <h1>‚è∞ –°—Å—ã–ª–∫–∞ –∏—Å—Ç–µ–∫–ª–∞</h1>
      <p>–ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É –≤ –±–æ—Ç–µ</p>
    </div>
  </div>
</template>

<script>
export default {
  async mounted() {
    const token = this.$route.query.token;
    if (token) {
      await this.checkToken(token);
    }
  },
  
  methods: {
    async checkToken(token) {
      const response = await fetch(`/api/identity/link-status/${token}`);
      const data = await response.json();
      
      this.tokenValid = data.valid;
      this.provider = data.provider;
    },
    
    async connectWallet() {
      // 1. –ó–∞–ø—Ä–æ—Å MetaMask
      const accounts = await window.ethereum.request({ 
        method: 'eth_requestAccounts' 
      });
      const address = accounts[0];
      
      // 2. –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–ø–∏—Å—å
      const message = `–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞: ${address}`;
      const signature = await window.ethereum.request({
        method: 'personal_sign',
        params: [message, address]
      });
      
      // 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      const token = this.$route.query.token;
      const response = await fetch('/api/auth/wallet-with-link', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address, signature, token })
      });
      
      const result = await response.json();
      
      if (result.success) {
        this.$router.push('/chat');
      }
    }
  }
};
</script>
```

---

## üîß –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –≠—Ç–∞–ø 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (2 —á–∞—Å–∞)

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ 068-070 (–Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã)
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 071 (–æ—á–∏—Å—Ç–∫–∞ –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 072 (–º–∏–≥—Ä–∞—Ü–∏—è guest_messages)
4. ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 073 (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–∞)
5. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–¥–∞–ª–µ–Ω—ã (users –ø—É—Å—Ç–∞)
7. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –∏ constraints
8. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –º–µ–¥–∏–∞ –≤ unified_guest_messages

### –≠—Ç–∞–ø 2: Backend —Å–µ—Ä–≤–∏—Å—ã (4 —á–∞—Å–∞)

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `UniversalGuestService.js`
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å `IdentityLinkService.js`
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å `UniversalMediaProcessor.js`
4. ‚úÖ **–ü–ï–†–ï–ü–ò–°–ê–¢–¨** `unifiedMessageProcessor.js`
5. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `telegramBot.js` (–¥–æ–±–∞–≤–∏—Ç—å `/connect` + –º–µ–¥–∏–∞)
6. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `emailBot.js` (–¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ + –º–µ–¥–∏–∞)
7. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `webBot.js` (–¥–æ–±–∞–≤–∏—Ç—å –º–µ–¥–∏–∞)
8. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `adminLogicService.js` –≤ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä

### –≠—Ç–∞–ø 3: Backend —Ä–æ—É—Ç—ã (1 —á–∞—Å)

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `/api/auth/wallet-with-link`
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å `/api/identity/link-status/:token`
3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `/api/chat/guest-message`
4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `/api/chat/message` (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–æ–≤)

### –≠—Ç–∞–ø 4: Frontend (2 —á–∞—Å–∞)

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `ConnectWalletView.vue`
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ä–æ—É—Ç `/connect-wallet`
3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —á–∞—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å identifier

### –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞-—Å–∏—Å—Ç–µ–º—ã (2 —á–∞—Å–∞)

1. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ `UniversalMediaProcessor`:
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤
   - –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - Fallback –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

2. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - Web: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
   - Telegram: –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤
   - Email: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π
   - –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç + –º–µ–¥–∏–∞)

3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î:
   - –ö–æ–ª–æ–Ω–∫–∏ `content_type`, `attachments`, `media_metadata`
   - –¢–∞–±–ª–∏—Ü–∞ `media_files`
   - –°–≤—è–∑–∏ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∏ —Ñ–∞–π–ª–∞–º–∏

### –≠—Ç–∞–ø 6: –û–±—â–µ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (3 —á–∞—Å–∞)

1. ‚úÖ Unit —Ç–µ—Å—Ç—ã –¥–ª—è `UniversalGuestService`
2. ‚úÖ Unit —Ç–µ—Å—Ç—ã –¥–ª—è `IdentityLinkService`
3. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:
   - Web –≥–æ—Å—Ç—å ‚Üí –∫–æ—à–µ–ª–µ–∫
   - Telegram ‚Üí —Å—Å—ã–ª–∫–∞ ‚Üí –∫–æ—à–µ–ª–µ–∫
   - Email ‚Üí —Å—Å—ã–ª–∫–∞ ‚Üí –∫–æ—à–µ–ª–µ–∫
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏
5. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω—Å–∫–æ–π –ª–æ–≥–∏–∫–∏

### –≠—Ç–∞–ø 6: Cleanup —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞ (1 —á–∞—Å)

1. ‚úÖ –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É –∏–∑ `guestService.js` (–∏–ª–∏ –ø–æ–º–µ—Ç–∏—Ç—å deprecated)
2. ‚úÖ –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É –∏–∑ `guestMessageService.js`
3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ú–û–ú–ï–ù–¢–´

### 1. –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≥–æ—Å—Ç–∏ –≤ `guest_messages`

**–†–µ—à–µ–Ω–∏–µ:** –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ SQL (071_migrate_existing_guest_data.sql)

### 2. –°—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)

**–†–µ—à–µ–Ω–∏–µ:** 
- –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é 071
- –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ - –≤—Å–µ –Ω–∞—á–∏–Ω–∞—é—Ç —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
- –í—Å–µ –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞

### 3. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–¥–∏–Ω –≥–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–∞–Ω–∞–ª–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
- `unified_guest_mapping` —Å UNIQUE constraint
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å

### 4. TTL —Ç–æ–∫–µ–Ω–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–æ–∫–µ–Ω—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ –ë–î

**–†–µ—à–µ–Ω–∏–µ:**
- Cron –∑–∞–¥–∞—á–∞: `identityLinkService.cleanupExpiredTokens()`
- –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤

---

## üìã CHECKLIST –ü–ï–†–ï–î –î–ï–ü–õ–û–ï–ú

- [ ] –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 068-072 –∑–∞–ø—É—â–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: —Ç–∞–±–ª–∏—Ü–∞ users –ø—É—Å—Ç–∞ (–≤—Å–µ —É–¥–∞–ª–µ–Ω–æ)
- [ ] `UniversalGuestService` –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏
- [ ] `IdentityLinkService` –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏
- [ ] Telegram bot –∫–æ–º–∞–Ω–¥–∞ `/connect` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Email bot –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É
- [ ] Web –≥–æ—Å—Ç–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –†–æ–ª–∏ (user/assistant) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] –ê–¥–º–∏–Ω—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞
- [ ] Frontend —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/connect-wallet` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –¢–æ–∫–µ–Ω—ã –∏—Å—Ç–µ–∫–∞—é—Ç –∏ –æ—á–∏—â–∞—é—Ç—Å—è
- [ ] –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ web –≥–æ—Å—Ç–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ unified_guest_messages
- [ ] –°—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã guest_messages –∏ guest_user_mapping —É–¥–∞–ª–µ–Ω—ã
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –°—Ç–∞—Ä—ã–π –∫–æ–¥ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ deprecated

---

## üìä –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –¥–æ–ª–∂–Ω—ã —É–ª—É—á—à–∏—Ç—å—Å—è:

1. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:** 0% –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏:** 100% AI –æ—Ç–≤–µ—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
3. **–ú–∏–≥—Ä–∞—Ü–∏—è:** 100% –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ì–æ—Å—Ç–∏ –≤–∏–¥—è—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
5. **Unified:** –í—Å–µ –∫–∞–Ω–∞–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω—É –ª–æ–≥–∏–∫—É

---

## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´

- `AI_DATABASE_STRUCTURE.md` - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î
- `AI_FULL_INVENTORY.md` - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
- `TASK_CHANNEL_ONBOARDING.md` - –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π (—Å–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞)

---

**–°—Ç–∞—Ç—É—Å:** üìã –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 2025-10-09

