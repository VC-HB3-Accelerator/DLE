# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Å—Ç–µ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤

## –ó–∞–¥–∞—á–∞
–ì–æ—Å—Ç–µ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ `unified_guest_messages` –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/contacts-list` –Ω–∞—Ä–∞–≤–Ω–µ —Å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–∞–±–ª–∏—Ü–∞ `unified_guest_messages` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è:
- `identifier_encrypted` (–∞ –Ω–µ `guest_identifier`)
- `content_encrypted` (–∞ –Ω–µ `content`)
- `is_ai` (–∞ –Ω–µ `is_ai_response`)
- –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ –ø–æ–ª–µ `user_id` –¥–ª—è —Å–≤—è–∑–∏ —Å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

**–†–µ—à–µ–Ω–∏–µ:** 
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `074_add_user_id_to_unified_guest_messages.sql`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `user_id INTEGER` —Å –≤–Ω–µ—à–Ω–∏–º –∫–ª—é—á–æ–º –Ω–∞ `users(id)`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å `idx_unified_guest_messages_user_id`
- ‚úÖ Constraint `ON DELETE SET NULL` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏

### 2. ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º –≤ —Ä–æ—É—Ç–∞—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –≤ SQL-–∑–∞–ø—Ä–æ—Å–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º `decrypt_text(identifier_encrypted, $key)` –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º `encryptionUtils.getEncryptionKey()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–∞

### 3. ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π GROUP BY –≤ SQL
**–ü—Ä–æ–±–ª–µ–º–∞:** –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø–æ–ª—é —Å–æ–∑–¥–∞–≤–∞–ª–∞ –¥—É–±–ª–∏:
```sql
SELECT DISTINCT
  decrypt_text(identifier_encrypted, $1) as guest_identifier,
  ...
FROM unified_guest_messages
GROUP BY identifier_encrypted, channel  -- ‚ùå –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º—É!
```

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CTE (Common Table Expression):
```sql
WITH decrypted_guests AS (
  SELECT 
    decrypt_text(identifier_encrypted, $1) as guest_identifier,
    channel,
    created_at,
    user_id
  FROM unified_guest_messages
  WHERE user_id IS NULL
)
SELECT 
  guest_identifier,
  channel,
  MIN(created_at) as created_at,
  MAX(created_at) as last_message_at,
  COUNT(*) as message_count
FROM decrypted_guests
GROUP BY guest_identifier, channel  -- ‚úÖ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º—É!
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. Backend: `GET /api/users` (routes/users.js)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥–æ—Å—Ç–µ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ `unified_guest_messages`
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: `WHERE user_id IS NULL` (—Ç–æ–ª—å–∫–æ –Ω–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –≥–æ—Å—Ç–∏)
- ‚úÖ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ `guest_identifier` + `channel`
- ‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

**–§–æ—Ä–º–∞—Ç –≥–æ—Å—Ç–µ–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞:**
```javascript
{
  id: "web:guest_abc123...",           // Unified identifier
  name: "üåê –ì–æ—Å—Ç—å (guest_ab...)",      // –ò–∫–æ–Ω–∫–∞ + –∫–∞–Ω–∞–ª + –∫–æ—Ä–æ—Ç–∫–∏–π ID
  email: null,                         // –ò–ª–∏ email –¥–ª—è –∫–∞–Ω–∞–ª–∞ email
  telegram: null,                      // –ò–ª–∏ ID –¥–ª—è –∫–∞–Ω–∞–ª–∞ telegram
  wallet: null,
  created_at: "2025-10-09T...",
  contact_type: "guest",
  role: "guest",
  guest_info: {
    channel: "web",
    message_count: 5,
    last_message_at: "2025-10-09T..."
  }
}
```

### 2. Backend: `GET /api/users/:id` (routes/users.js)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ ID: –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç `:` ‚Üí —ç—Ç–æ –≥–æ—Å—Ç–µ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- ‚úÖ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ CTE
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–æ—Å—Ç–µ

### 3. Backend: `GET /api/messages?userId=...` (routes/messages.js)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ `userId`: –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç `:` ‚Üí —ç—Ç–æ –≥–æ—Å—Ç—å
- ‚úÖ –ó–∞–ø—Ä–æ—Å –∫ `unified_guest_messages` –≤–º–µ—Å—Ç–æ `messages`
- ‚úÖ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–æ–ª–µ–π: `identifier_encrypted`, `content_encrypted`
- ‚úÖ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ `is_ai` ‚Üí `sender_type` ('bot' –∏–ª–∏ 'user')
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**
```javascript
{
  id: 123,
  user_id: "web:guest_abc123...",
  sender_type: "user",              // –∏–ª–∏ "bot"
  content: "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
  channel: "web",
  role: "guest",
  direction: "outgoing",            // –∏–ª–∏ "incoming"
  created_at: "2025-10-09T...",
  content_type: "text",             // –∏–ª–∏ "audio", "video", "image", "combined"
  attachments: [...],               // JSONB —Å –º–µ–¥–∏–∞
  media_metadata: {...}             // JSONB —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
}
```

## Frontend

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:** –ù–µ —Ç—Ä–µ–±—É—é—Ç—Å—è! ‚úÖ

Frontend —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å:
- `GET /api/users` ‚Üí –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
- `GET /api/users/:id` ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞
- `GET /api/messages?userId=...` ‚Üí –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞

–ë–ª–∞–≥–æ–¥–∞—Ä—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –±—ç–∫–µ–Ω–¥–µ, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥–æ—Å—Ç–µ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü–µ
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∫–æ–Ω–∫–∏ –ø–æ —Ç–∏–ø—É –∫–∞–Ω–∞–ª–∞ (üåê, üì±, ‚úâÔ∏è)
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –≥–æ—Å—Ç—è

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –≥–æ—Å—Ç–µ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```bash
curl -X POST http://localhost:3001/api/chat/guest-message \
  -H "Content-Type: application/json" \
  -d '{"content":"–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≥–æ—Å—Ç—è"}'
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
```bash
curl http://localhost:3001/api/users | jq '.contacts[] | select(.contact_type == "guest")'
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –≥–æ—Å—Ç—è
```bash
curl http://localhost:3001/api/users/web:guest_abc123... | jq .
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≥–æ—Å—Ç—è
```bash
curl "http://localhost:3001/api/messages?userId=web:guest_abc123..." | jq .
```

## –°—Ç–∞—Ç—É—Å

‚úÖ **–ì–û–¢–û–í–û (100%)**

- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è 074 –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- ‚úÖ `GET /api/users` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Å—Ç–µ–π
- ‚úÖ `GET /api/users/:id` —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≥–æ—Å—Ç—è–º–∏
- ‚úÖ `GET /api/messages?userId=...` —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≥–æ—Å—Ç—è–º–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π GROUP BY —á–µ—Ä–µ–∑ CTE
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ—Å—Ç–µ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ `/contacts-list`
2. **–ú–∏–≥—Ä–∞—Ü–∏—è –≥–æ—Å—Ç–µ–π:** –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞ –æ–±–Ω–æ–≤–ª—è—Ç—å `user_id` –≤ `unified_guest_messages`
3. **–§–∏–ª—å—Ç—Ä—ã:** –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –∫–æ–Ω—Ç–∞–∫—Ç–∞ (user/guest/admin) –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

